<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Attles Law Group</title>
    <meta name="description" content="Request a password reset link for your Attles Law Group account.">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/auth.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="auth-page">
    <header class="header">
        <nav class="navbar container">
            <div class="nav-brand">
                <a href="../../index.html"><img src="../../assets/images/logo.png" alt="Attles Law Group Logo" class="logo"></a>
            </div>
            <div class="nav-actions">
                <a href="./login.html" class="btn btn-outline">Sign In</a>
                <select id="languageSwitcher" class="language-switcher">
                    <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
                    <option value="am">ðŸ‡ªðŸ‡¹ áŠ áˆ›</option>
                    <option value="fr">ðŸ‡«ðŸ‡· FR</option>
                    <option value="ar">ðŸ‡¸ðŸ‡¦ AR</option>
                    <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
                </select>
            </div>
        </nav>
    </header>
    <main class="auth-container">
        <div class="auth-content">
            <div class="auth-form-container" style="margin:auto;">
                <div class="auth-form-wrapper">
                    <div class="auth-form-header">
                        <h2>Forgot Password</h2>
                        <p>Enter your email to receive a password reset link.</p>
                    </div>
                    <form id="forgotForm" class="auth-form" novalidate>
                        <div class="form-group">
                            <label for="email" class="form-label"><i class="fas fa-envelope"></i> Email Address</label>
                            <input type="email" id="email" name="email" class="form-input" placeholder="you@example.com" required>
                            <span class="form-error" id="emailError"></span>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block" id="forgotBtn">Send Reset Link</button>
                        <div class="form-footer">
                            <p>Remembered your password? <a href="./login.html" class="form-link-primary">Sign In</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    <script src="../../js/main.js"></script>
    <script src="../../js/api.js"></script>

    <script>
        class ForgotHandler {
            constructor() {
                this.form = document.getElementById('forgotForm');
                this.emailInput = document.getElementById('email');
                this.forgotBtn = document.getElementById('forgotBtn');
                this.init();
            }
            init() {
                this.form.addEventListener('submit', e => this.handleSubmit(e));
            }
            showError(id, msg) {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = msg;
                    el.classList.add('visible');
                }
            }
            clearError(id) {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = '';
                    el.classList.remove('visible');
                }
            }
            setLoading(is) {
                if (this.forgotBtn) {
                    this.forgotBtn.disabled = is;
                    this.forgotBtn.textContent = is ? 'Sending...' : 'Send Reset Link';
                }
            }
            async handleSubmit(e) {
                e.preventDefault();
                const email = this.emailInput.value.trim();
                if (!email) return this.showError('emailError','Email is required');
                const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!regex.test(email)) return this.showError('emailError','Invalid email');
                this.clearError('emailError');
                this.setLoading(true);
                try {
                    // Use correct backend endpoint
                    const response = await fetch('http://localhost:5000/api/auth/request-reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        // Show notification
                        if (window.AppUtils && window.AppUtils.NotificationManager) {
                            window.AppUtils.NotificationManager.show('Reset link sent! Redirecting to reset page...', 'success', 3000);
                        } else {
                            alert('Reset link sent! Redirecting to reset page...');
                        }

                        // Redirect after short delay to reset-password page with email query param
                        setTimeout(() => {
                            const target = './reset-password.html?email=' + encodeURIComponent(email);
                            window.location.href = target;
                        }, 3000);

                        this.form.reset();
                    } else {
                        if (window.AppUtils && window.AppUtils.NotificationManager) {
                            window.AppUtils.NotificationManager.show(data.error || 'Error sending reset link','error',5000);
                        } else {
                            alert(data.error || 'Error sending reset link');
                        }
                    }
                } catch(err) {
                    if (window.AppUtils && window.AppUtils.NotificationManager) {
                        window.AppUtils.NotificationManager.show('Network error. Please try again.','error',5000);
                    } else {
                        alert('Network error. Please try again.');
                    }
                } finally {
                    this.setLoading(false);
                }
            }
        }
        document.addEventListener('DOMContentLoaded',()=>new ForgotHandler());
    </script>
</body>
</html>